require 'date'

module Schema2type
  $convert_types = []
  $schema_version = ''

  def self.execute(input_file:, out_file:, name_space:, snake_case:)
    $snake_case = snake_case
    eval(File.read(input_file))

    convert_type_text = $convert_types.map { |t| "  #{t}" }.join("\n").strip

    File.open(out_file, "w") do |f|
      f.puts <<-EOS
/* eslint no-unused-vars: 0 */

/**
 * auto-generated file @#{Date.today.to_time}
 * schema version: #{$schema_version}
 * This file was automatically generated by schema2type
 */
declare namespace #{name_space ||= "schema"} {
  #{convert_type_text}
}
EOS
    end
  end

  def self.create_table(table_name, *arg, &block)
    converter = SchemaConverter.new(table_name: table_name, snake_case: $snake_case)
    block.call(converter)
    converter.finalize

    $convert_types.concat(converter.out_text)
  end

  def self.method_missing(*arg)
    # To exclude unnecessary methods
  end

  module ActiveRecord
    class Schema
      def self.define(version, &block)
        $schema_version = version[:version]
        block.call
      end
    end
  end
end
